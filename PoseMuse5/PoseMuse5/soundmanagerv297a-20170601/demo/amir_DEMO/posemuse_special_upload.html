<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!--player css-->
  <link rel="stylesheet" type="text/css" href="360player.css" />

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="bootstrap.css" crossorigin="anonymous">

  <title>Upload audio!</title>
</head>

<body>

  <div class="container">


    <div class="row">

      <div class="col">


        <div class="mb-3 mt-3">


          <h2 class="mb-3" style="font-weight: 3000;">upload your song</h2>

          <div class="form-group mb-3">

            <div class="custom-file">

              <input type="file" class="custom-files-input" id="file_input" oninput="input_filename()">
              <label for="file_input" id="file_input_label" class="custom-file-label">select file</label>


            </div>


          </div>

          <button onclick="upload()" id="btn_upload" class="btn btn-primary">upload file</button>
          <button class="btn btn-primary hidden" id="loading_btn" type="button" disabled>
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            uploading...
          </button>
          <button type="button" class="btn btn-default hidden " id="upload_cancel">cancel upload</button>


        </div>

        <div id="progress_wrapper" class="hidden">

          <label id="progress_status">30% uploaded</label>
          <div class="progress mb-3">

            <div  id="progress" class="progress-bar" role="progressbar" aria-valuenow="25" aria-valuemin="0"
              aria-valuemax="100"  >
            </div>
          </div>



        </div>
        <div id="alert_wrapper">



        </div>
      </div>
    </div>
  </div>


<script>

var progress = document.getElementById("progress");
var progress_wrapper = document.getElementById("progress_wrapper");
var progress_status = document.getElementById("progress_status");

var upload_cancel= document.getElementById("upload_cancel");
var btn_upload = document.getElementById("btn_upload");
var loading_btn = document.getElementById("loading_btn");


var alert_wrapper=document.getElementById("alert_wrapper");


var file_input = document.getElementById("file_input");
var file_input_label =document.getElementById("file_input_label");

function input_filename()
{
  file_input_label.innerText=file_input.files[0].name
}

function show_alert(message,type_)
{
  console.log(message);
  console.log(type_);
  const alert_=`<div class="alert alert-`+type_+` alert-dismissable">
  <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
`+message+`
</div>`; 
console.log(alert_)

alert_wrapper.innerHTML=alert_;
}

function upload()
{

  if (!file_input.value)
  {
    show_alert('no file selected','danger')
    return;

  }


  upload_cancel.classList.remove("hidden");
  loading_btn.classList.remove("hidden");
  progress_wrapper.classList.remove("hidden");


  

  const url = 'http://localhost:3000/audition/upload'
  const file = file_input.files[0];
  const formData = new FormData()



var json = {
    id:17
}

var ok = JSON.stringify(json)
    formData.append('Demo', file)
    formData.append('id',ok)




  
var xhttp = new XMLHttpRequest() ;
xhttp.open('POST',url,true);


xhttp.upload.addEventListener('progress',function(e)

{
  var loaded = e.loaded;
  var total = e.total;
  var percentage = (loaded/total) * 100 ;
  console.log(percentage);
  progress.setAttribute("style","width:"+Math.round(percentage)+"%");
  progress_status.innerText =Math.round(percentage)+"%";

  

})
  


xhttp.addEventListener("load",function(e)
{

  if (xhttp.status==200)
  {
    reset();
    show_alert(xhttp.response,'success');

  }
  else
  {    show_alert('error uploading file','danger');


  }
})


upload_cancel.addEventListener('click',function()
{

xhttp.abort();
show_alert('Request Canceled',"warning")
  reset();
})



// xhttp.onreadystatechange=function()
// {
//     if (xhttp.status==200)
//     {
//       show_alert(xhttp.response,'success');
       
        
//     }
// }

xhttp.send(formData);

}
//upload finish

reset = function()
{
btn_upload.classList.remove("hidden");
loading_btn.classList.add("hidden");
progress_wrapper.classList.add("hidden");
progress.setAttribute("style","width:0%");
upload_cancel.classList.add("hidden")

file_input_label.innerText='Select File';

}


</script>



</body>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
  integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
  integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
  integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
<!-- <script src="now.js"></script> -->
<!-- Apache-licensed animation library -->
<script type="text/javascript" src="script/berniecode-animator.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.serializeJSON/2.9.0/jquery.serializejson.js"></script>
<!-- the core stuff -->
<script type="text/javascript" src="../../script/soundmanager2.js"></script>

<script type="text/javascript" src="script/360player.js"></script>

<script type="text/javascript">
  soundManager.setup({
    // path to directory containing SM2 SWF
    url: '../../swf/'
  });
</script>

</html>